#!/bin/bash
# k8s-gather: Compatible with vanilla k8s, adoption of must-gather

source functions.sh

# for new flag to get since and since-time
get_log_collection_args

# Create output directory
mkdir -p "$DST_DIR"

# Set operator namespace (use env var if set, otherwise detect dynamically)
if [[ -n "${OPERATOR_NAMESPACE}" ]]; then
    OPERATOR_NS="${OPERATOR_NAMESPACE}"
else
    # Dynamically detect operator namespace
    detected_ns=$(get_operator_ns "opendatahub-operator")
    if [ -z "${detected_ns}" ]; then
        detected_ns=$(get_operator_ns "rhods-operator")
    fi
    OPERATOR_NS="${detected_ns:-redhat-ods-operator}"
fi

# Map operator namespace to application namespace (only if not already set)
if [[ -z "${APPLICATIONS_NAMESPACE}" ]]; then
    case "${OPERATOR_NS}" in
        openshift-operators)
            APPLICATIONS_NS="opendatahub"
            ;;
        redhat-ods-operator)
            APPLICATIONS_NS="redhat-ods-applications"
            ;;
        *)
            echo "Error: Operator namespace '${OPERATOR_NS}' is not supported."
            echo "Supported namespaces: openshift-operators, redhat-ods-operator"
            echo "Or set both OPERATOR_NAMESPACE and APPLICATIONS_NAMESPACE environment variables."
            exit 1
            ;;
    esac
else
    APPLICATIONS_NS="${APPLICATIONS_NAMESPACE}"
fi

# Istio namespace - use distribution-specific default from distro files
ISTIO_NS=${ISTIO_NAMESPACE:-${DEFAULT_ISTIO_NS}}

# Route namespace (OpenShift only)
if [[ "${K8S_DISTRO}" == "ocp" ]]; then
    ROUTE_NS=${ROUTE_NAMESPACE:-${DEFAULT_ROUTE_NS:-openshift-ingress}}
fi

# generate 'info' file
cat > "$DST_DIR/info" <<EOF
k8s-gather
Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
Kubernetes: $($KUBECTL version --short 2>/dev/null || $KUBECTL version -o json 2>/dev/null | jq -r '.serverVersion.gitVersion')
Distribution: ${K8S_DISTRO}
$(get_operator_version "$OPERATOR_NS")

COMPONENT=${COMPONENT:-all}
ENABLE_SERVING=${ENABLE_SERVING:-true}
ENABLE_KUEUE=${ENABLE_KUEUE:-false}
ENABLE_KUBERAY=${ENABLE_KUBERAY:-false}
OPERATOR_NAMESPACE=${OPERATOR_NS}
APPLICATIONS_NAMESPACE=${APPLICATIONS_NS}
ISTIO_NAMESPACE=${ISTIO_NS}
MUST_GATHER_SINCE=${MUST_GATHER_SINCE:-}
MUST_GATHER_SINCE_TIME=${MUST_GATHER_SINCE_TIME:-}
EOF

# Collect core namespaces
kubectl_inspect "namespace/$OPERATOR_NS" || echo "Namespace ${OPERATOR_NS} not found"
kubectl_inspect "namespace/$APPLICATIONS_NS" || echo "Namespace ${APPLICATIONS_NS} not found"
kubectl_inspect "namespace/$ISTIO_NS" || echo "Namespace ${ISTIO_NS} not found"

# Collect route namespace (OpenShift only)
if [[ "${K8S_DISTRO}" == "ocp" ]]; then
    kubectl_inspect "namespace/$ROUTE_NS" || echo "Namespace ${ROUTE_NS} not found"
fi

# Collect cluster-scoped resources
resources=(
  # Core k8s (v1)
  "nodes"
  "persistentvolumes"
  "clusterroles.rbac.authorization.k8s.io"
  "clusterrolebindings.rbac.authorization.k8s.io"
  "storageclasses.storage.k8s.io"
  "customresourcedefinitions.apiextensions.k8s.io"
  "priorityclasses.scheduling.k8s.io"
  # Admission webhooks
  "mutatingwebhookconfigurations.admissionregistration.k8s.io"
  "validatingwebhookconfigurations.admissionregistration.k8s.io"
  "validatingadmissionpolicies.admissionregistration.k8s.io"
  "validatingadmissionpolicybindings.admissionregistration.k8s.io"
  # ODH/RHOAI
  "dscinitializations.dscinitialization.opendatahub.io"
  "datascienceclusters.datasciencecluster.opendatahub.io"
  "kserves.components.platform.opendatahub.io"
  "kueues.components.platform.opendatahub.io"
  "rays.components.platform.opendatahub.io"
)
get_operator_resource "${resources[@]}"

# set component or default to all
component=${COMPONENT:-all}
case "$component" in
    "llm-d"|"kserve")
        /usr/bin/k8s-gather/component/llm-d.sh
        ;;
    "kuberay")
        /usr/bin/k8s-gather/component/kuberay.sh
        ;;
    "kueue")
        /usr/bin/k8s-gather/component/kueue.sh
        ;;
    *) # for all - run enabled components in parallel
        [[ "$ENABLE_SERVING" == "true" ]] && /usr/bin/k8s-gather/component/llm-d.sh &
        [[ "$ENABLE_KUBERAY" == "true" ]] && /usr/bin/k8s-gather/component/kuberay.sh &
        [[ "$ENABLE_KUEUE" == "true" ]] && /usr/bin/k8s-gather/component/kueue.sh
        ;;
esac

# Dependency operators (always collected)
/usr/bin/k8s-gather/deps/cert-manager.sh &
/usr/bin/k8s-gather/deps/sail.sh &
/usr/bin/k8s-gather/deps/lws.sh &

# Infrastructure components from upstream
/usr/bin/k8s-gather/gather_istio &
# /usr/bin/k8s-gather/gather_metallb &  # disabled: issue with name
/usr/bin/k8s-gather/gather_sriov &

# wait for all background jobs to complete
wait

# force disk flush to ensure that all data gathered is accessible in the copy container
sync

echo "k8s-gather complete. Output in: $DST_DIR"
