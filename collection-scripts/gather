#!/bin/bash
# k8s-gather: Compatible with vanilla k8s, adoption of must-gather

# Get script directory for sourcing
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common.sh which loads functions.sh
source "$SCRIPT_DIR/common.sh"

# for new flag to get since and since-time
get_log_collection_args

# Create output directory
mkdir -p "$DST_DIR"

# Set operator and application namespaces
if [[ -n "${OPERATOR_NAMESPACE}" ]]; then
    # Use env vars if provided
    OPERATOR_NS="${OPERATOR_NAMESPACE}"
    APPLICATIONS_NS="${APPLICATIONS_NAMESPACE:-redhat-ods-applications}"
else
    # Detect operator namespace from subscriptions
    OPERATOR_NS=$(get_operator_ns)
    if [[ -z "${OPERATOR_NS}" ]]; then
        echo "ERROR: No operator subscription found (rhods-operator or opendatahub-operator)."
        echo "Set OPERATOR_NAMESPACE and APPLICATIONS_NAMESPACE environment variables to override."
        exit 1
    fi
    # APPLICATIONS_NS is set by get_operator_ns function
fi

# generate 'info' file
cat > "$DST_DIR/info" <<EOF
k8s-gather
Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
Kubernetes: $($KUBECTL version --short 2>/dev/null || $KUBECTL version -o json 2>/dev/null | jq -r '.serverVersion.gitVersion')
Distribution: ${K8S_DISTRO}
$(get_operator_version "$OPERATOR_NS")

Collection Configuration:
$( if [[ "${ENABLE_ALL}" == "true" ]]; then
    echo "  Collecting ALL components:"
    echo "    - KServe/LLM-D"
    echo "    - Kueue"
    echo "    - KubeRay"
    echo "    - Monitoring"
else
    echo "  Collecting enabled components:"
    [[ "${ENABLE_SERVING}" == "true" ]] && echo "    - KServe/LLM-D (enabled)" || echo "    - KServe/LLM-D (disabled, skipped)"
    [[ "${ENABLE_KUEUE}" == "true" ]] && echo "    - Kueue (enabled)" || echo "    - Kueue (disabled, skipped)"
    [[ "${ENABLE_KUBERAY}" == "true" ]] && echo "    - KubeRay (enabled)" || echo "    - KubeRay (disabled, skipped)"
    [[ "${ENABLE_MONITORING}" == "true" ]] && echo "    - Monitoring (enabled)" || echo "    - Monitoring (disabled, skipped)"
fi )

Namespaces:
  OPERATOR_NAMESPACE=${OPERATOR_NS}
  APPLICATIONS_NAMESPACE=${APPLICATIONS_NS}
$( [[ -n "${ROUTE_NS}" ]] && echo "  ROUTE_NAMESPACE=${ROUTE_NS}" )

Log Filters:
  MUST_GATHER_SINCE=${MUST_GATHER_SINCE:-none}
  MUST_GATHER_SINCE_TIME=${MUST_GATHER_SINCE_TIME:-none}
EOF

# Collect core namespaces
kubectl_inspect "namespace/$OPERATOR_NS" || echo "Namespace ${OPERATOR_NS} not found"
kubectl_inspect "namespace/$APPLICATIONS_NS" || echo "Namespace ${APPLICATIONS_NS} not found"

# Collect route namespace (if set, e.g., on OpenShift)
if [[ -n "${ROUTE_NS}" ]]; then
    kubectl_inspect "namespace/$ROUTE_NS" || echo "Namespace ${ROUTE_NS} not found"
fi

# Collect cluster-scoped resources
resources=(
  # Core k8s (v1)
  "nodes"
  "persistentvolumes"
  "clusterroles.rbac.authorization.k8s.io"
  "clusterrolebindings.rbac.authorization.k8s.io"
  "storageclasses.storage.k8s.io"
  "customresourcedefinitions.apiextensions.k8s.io"
  "priorityclasses.scheduling.k8s.io"
  # Admission webhooks
  "mutatingwebhookconfigurations.admissionregistration.k8s.io"
  "validatingwebhookconfigurations.admissionregistration.k8s.io"
  "validatingadmissionpolicies.admissionregistration.k8s.io"
  "validatingadmissionpolicybindings.admissionregistration.k8s.io"
  # ODH/RHOAI
  "dscinitializations.dscinitialization.opendatahub.io"
  "datascienceclusters.datasciencecluster.opendatahub.io"
  "kserves.components.platform.opendatahub.io"
  "kueues.components.platform.opendatahub.io"
  "rays.components.platform.opendatahub.io"
)
get_operator_resource "${resources[@]}"

# Component collection
if [[ "${ENABLE_ALL}" == "true" ]]; then
    # Collect all components
    $SCRIPT_DIR/component/llm-d.sh &
    $SCRIPT_DIR/component/kuberay.sh &
    $SCRIPT_DIR/component/kueue.sh &
    $SCRIPT_DIR/component/monitoring.sh
else
    # Collect only enabled components
    [[ "${ENABLE_SERVING}" == "true" ]] && $SCRIPT_DIR/component/llm-d.sh &
    [[ "${ENABLE_KUBERAY}" == "true" ]] && $SCRIPT_DIR/component/kuberay.sh &
    [[ "${ENABLE_KUEUE}" == "true" ]] && $SCRIPT_DIR/component/kueue.sh &
    [[ "${ENABLE_MONITORING}" == "true" ]] && $SCRIPT_DIR/component/monitoring.sh
fi

# Dependency operators (always collected)
$SCRIPT_DIR/deps/cert-manager.sh &
$SCRIPT_DIR/deps/sail.sh &
$SCRIPT_DIR/deps/lws.sh &

# Infrastructure components from upstream
$SCRIPT_DIR/gather_istio &
# $SCRIPT_DIR/gather_metallb &  # disabled: issue with name
$SCRIPT_DIR/gather_sriov &

# wait for all background jobs to complete
wait

# force disk flush to ensure that all data gathered is accessible in the copy container
sync

echo "k8s-gather complete. Output in: $DST_DIR"
